<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Artifact {{ artifact.id }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; max-width: 1000px; }
      .muted { color: #666; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-top: 14px; }
      pre { white-space: pre-wrap; background: #f7f7f7; padding: 10px; border-radius: 10px; }
      code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
      button { padding: 8px 12px; font-weight: 600; }
      table { width: 100%; border-collapse: collapse; }
      td, th { border-bottom: 1px solid #eee; padding: 8px; vertical-align: top; }
    </style>
  </head>
  <body>
    <p>
      {% set page_title = "Artifact #{}".format(artifact.id) %}
      {% include "_nav.html" %}

    </p>

    <div class="muted">
      kind={{ artifact.kind }} · mime={{ artifact.mime_type or "?" }} · created={{ artifact.created_at }}
    </div>

    <div class="card">
      <div><strong>Links</strong></div>
      {% if artifact.storage_path %}
        <div><a href="{{ artifact.storage_path }}" target="_blank">Open file</a></div>
      {% endif %}
      {% if building %}
        <div>Building: <a href="/review/buildings/{{ building.id }}">{{ building.name }}</a></div>
      {% endif %}
      {% if park %}
        <div>Park: <a href="/review/parks/{{ park.id }}">{{ park.name }}</a></div>
      {% endif %}
    </div>
<div class="card">
  <div style="display:flex; justify-content: space-between; align-items:center; gap: 12px;">
    <strong>Actions</strong>

    <div style="display:flex; gap:10px; flex-wrap: wrap;">
      <form method="post" action="/ui/artifacts/{{ artifact.id }}/discover">
        <button type="submit">Run discovery</button>
      </form>

      <form method="post" action="/ui/artifacts/{{ artifact.id }}/retry-failed">
        <button type="submit">Retry failed jobs</button>
      </form>

      <form method="post" action="/ui/artifacts/{{ artifact.id }}/rerun-pipeline">
        <button type="submit">Rerun pipeline</button>
      </form>
    </div>
  </div>

  <div class="muted" style="margin-top: 8px;">
    Retry creates new queued jobs (keeps history). “Rerun pipeline” queues extract_text → structured → discovery.
  </div>

  <div style="margin-top: 10px;">
    <form method="post" action="/ui/artifacts/{{ artifact.id }}/retry" style="display:flex; gap: 10px; align-items: center;">
      <label class="muted" style="min-width: 130px;">Retry job type:</label>
      <select name="job_type">
        <option value="extract_text">extract_text</option>
        <option value="extract_structured">extract_structured</option>
        <option value="extract_discovery">extract_discovery</option>
        <option value="transcribe_audio">transcribe_audio</option>
      </select>
      <button type="submit">Retry</button>
    </form>
  </div>
</div>
    <div class="card">
      <strong>Processing jobs</strong>
      {% if jobs|length == 0 %}
        <div class="muted">No jobs recorded.</div>
      {% else %}
        <table>
          <tr><th>ID</th><th>Type</th><th>Status</th><th>Attempts</th><th>Error</th></tr>
          {% for j in jobs %}
            <tr>
              <td>{{ j.id }}</td>
              <td>{{ j.job_type }}</td>
              <td>{{ j.status }}</td>
              <td>{{ j.attempts }}</td>
              <td class="muted">{{ j.last_error or "" }}</td>
            </tr>
          {% endfor %}
        </table>
      {% endif %}
    </div>

    <div class="card">
      <strong>Claims</strong>
      {% if claims|length == 0 %}
        <div class="muted">No claims yet.</div>
      {% else %}
        <table>
          <tr><th>Key</th><th>Confidence</th><th>Value JSON</th></tr>
          {% for c in claims %}
            <tr>
              <td><code>{{ c.field_key }}</code></td>
              <td>{{ "%.2f"|format(c.confidence) }}</td>
              <td class="muted"><code>{{ c.value_json }}</code></td>
            </tr>
          {% endfor %}
        </table>
      {% endif %}
    </div>

    <div class="card">
  <div><strong>Extracted text</strong></div>

  {% if segments|length == 0 %}
    <div class="muted">No extracted text segments yet.</div>
  {% else %}
    {% for s in segments %}
      <div class="muted" style="margin-top: 10px;">
        segment {{ s.segment_index }}
        {% if s.source_ref %} | {{ s.source_ref }}{% endif %}
        | {{ s.text|length }} chars
      </div>
      <div style="margin-top: 6px; white-space: pre-wrap;">{{ s.text }}</div>
    {% endfor %}
  {% endif %}
    </div>
  </body>
</html>
